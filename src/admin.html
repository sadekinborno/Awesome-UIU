<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Admin Panel - Student Hub</title>
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --glass-bg: rgba(15, 23, 42, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--danger) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            font-weight: 900;
        }

        .header p {
            color: var(--text-secondary);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dept-table {
            width: 100%;
            border-collapse: collapse;
        }

        .dept-table th,
        .dept-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .dept-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dept-table td {
            font-size: 1rem;
        }

        .dept-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-export {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .danger-zone {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .danger-zone h3 {
            color: var(--danger);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .warning-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .current-trimester {
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .back-link {
            text-align: center;
            margin-top: 2rem;
        }

        .back-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        /* Tabs (Admin sections) */
        .tablist {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: thin;
            padding: 0.25rem 0.15rem;
        }

        .tab-btn {
            padding: 0.6rem 0.95rem;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-weight: 750;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .tab-btn[aria-selected="true"] {
            background: rgba(99, 102, 241, 0.22);
            border-color: rgba(99, 102, 241, 0.65);
            box-shadow: 0 10px 26px rgba(99, 102, 241, 0.16);
        }

        .tab-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }

        .tab-panels {
            display: block;
        }

        .tab-panel[hidden] {
            display: none !important;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 0 0 auto;
        }

        /* Sticky top navigation for admin sections */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(2, 6, 23, 0.65);
            backdrop-filter: blur(18px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            padding: 0.85rem 1rem;
            margin: 1.25rem 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .topbar-left {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            min-width: 180px;
        }

        .topbar-title {
            font-weight: 800;
            letter-spacing: 0.2px;
        }

        .topbar-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.6rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-weight: 650;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .nav-btn.danger {
            border-color: rgba(239, 68, 68, 0.45);
            background: rgba(239, 68, 68, 0.12);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.04);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .table-scroll {
            overflow-x: auto;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            font-size: 0.8rem;
            font-weight: 650;
            white-space: nowrap;
        }

        .chip.warning {
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.35);
            color: #fbbf24;
        }

        .chip.success {
            background: rgba(16, 185, 129, 0.12);
            border-color: rgba(16, 185, 129, 0.35);
            color: #34d399;
        }

        .chip.muted {
            background: rgba(148, 163, 184, 0.08);
            border-color: rgba(148, 163, 184, 0.25);
            color: var(--text-secondary);
        }

        @media (max-width: 700px) {
            .topbar {
                flex-direction: column;
                align-items: stretch;
            }

            .topbar-left {
                align-items: center;
                text-align: center;
            }

            .nav-actions {
                justify-content: center;
            }
        }

        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }

        .login-card {
            max-width: 400px;
            width: 100%;
        }

        .login-input {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            margin-bottom: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        #adminPanel {
            display: none;
        }

        .trimester-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            margin-bottom: 1rem;
        }

        .trimester-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .active-trimester-display {
            text-align: center;
            padding: 2rem;
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid var(--primary);
            border-radius: 16px;
            margin-bottom: 1.5rem;
        }

        .active-trimester-display .trimester-value {
            font-size: 2.5rem;
            color: var(--primary);
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .active-trimester-display .trimester-note {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-content h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .modal-content p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card glass-card">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">üîê Admin Access</h2>
            <input
                type="email"
                id="adminEmailInput"
                class="login-input"
                placeholder="Admin email"
                autocomplete="username"
            >
            <input
                type="password"
                id="adminPasswordInput"
                class="login-input"
                placeholder="Password"
                autocomplete="current-password"
            >
            <button class="btn btn-danger" onclick="adminSignIn()">
                Sign in
            </button>
            <div style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.85rem; line-height: 1.4;">
                <div style="margin-bottom: 0.4rem;">
                    This admin panel uses Supabase Auth + <strong>admin_roles</strong>.
                </div>
                <div style="margin-bottom: 0.35rem; font-weight: 600; color: var(--text-primary);">First-time setup</div>
                <ol style="margin: 0; padding-left: 1.2rem;">
                    <li>Run <strong>admin-auth-setup.sql</strong> in Supabase SQL Editor.</li>
                    <li>Dashboard ‚Üí Authentication ‚Üí Users ‚Üí <strong>Add user</strong> (email + password).</li>
                    <li>Copy that user‚Äôs <strong>UUID</strong> and insert it into <strong>public.admin_roles</strong> (see admin-auth-setup.sql).</li>
                </ol>
                <div style="margin-top: 0.35rem;">
                    Then sign in here with the same email/password.
                </div>
            </div>
            <div class="back-link" style="margin-top: 1.5rem;">
                <a href="index.html">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden until login) -->
    <div id="adminPanel">
        <div class="container">
            <div class="header">
                <h1>üîê Admin Panel</h1>
                <p>Manage the whole Student Hub (users, scholarship, teacher reviews, analytics)</p>
            </div>

            <!-- Sticky Nav -->
            <div class="topbar">
                <div class="topbar-left">
                    <div class="topbar-title">Student Hub Admin</div>
                    <div class="topbar-meta">Active trimester: <span class="pill" id="activeTrimesterMini">Loading‚Ä¶</span></div>
                </div>
                <div class="tablist" id="adminTablist" role="tablist" aria-label="Admin sections">
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="dashboard" aria-controls="tab-dashboard" aria-selected="true">Dashboard</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="teachers" aria-controls="tab-teachers" aria-selected="false">Teachers</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="analytics" aria-controls="tab-analytics" aria-selected="false">Analytics</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="trimester" aria-controls="tab-trimester" aria-selected="false">Trimester</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="scholarship" aria-controls="tab-scholarship" aria-selected="false">Scholarship</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="users" aria-controls="tab-users" aria-selected="false">Users</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="export" aria-controls="tab-export" aria-selected="false">Export</button>
                    <button class="tab-btn" type="button" role="tab" data-admin-tab="danger" aria-controls="tab-danger" aria-selected="false">Danger</button>
                </div>
                <div class="topbar-right">
                    <button class="nav-btn danger" type="button" onclick="logoutAdmin()">Logout</button>
                </div>
            </div>

            <div class="tab-panels">
                <section class="tab-panel" id="tab-dashboard" role="tabpanel">

            <!-- Quick Actions -->
            <div class="glass-card" id="quickActions" style="background: rgba(99, 102, 241, 0.1); border-color: var(--primary);">
                <h2>‚ö° Quick Actions</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="loadRecentSubmissions(10)" style="padding: 1rem; font-size: 0.9rem;">
                        üìã View Recent 10
                    </button>
                    <button class="btn btn-secondary" onclick="loadFlaggedSubmissions()" style="padding: 1rem; font-size: 0.9rem;">
                        üö© Load Flagged Queue
                    </button>
                    <button class="btn btn-export" onclick="exportData()" style="padding: 1rem; font-size: 0.9rem;">
                        üì• Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="setAdminTab('users'); setTimeout(() => document.getElementById('searchEmailInput')?.focus(), 50);" style="padding: 1rem; font-size: 0.9rem;">
                        üîç Search User
                    </button>
                    <button class="btn btn-secondary" onclick="loadAdminData()" style="padding: 1rem; font-size: 0.9rem;">
                        üîÑ Refresh Stats
                    </button>
                </div>
            </div>

            <!-- Site Overview (Whole Hub) -->
            <div class="glass-card" id="siteOverviewSection">
                <h2>üåê Site Overview</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Quick snapshot across Users, Scholarship, and Teacher Reviews.
                </p>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="siteTotalUsers">‚Äî</div>
                        <div class="stat-label">Registered Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="siteVerifiedUsers">‚Äî</div>
                        <div class="stat-label">Verified Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="siteTeacherReviews">‚Äî</div>
                        <div class="stat-label">Teacher Reviews</div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="loadSiteOverview()" style="width: 100%;">
                    üîÑ Refresh Site Overview
                </button>
            </div>

                </section>

                <section class="tab-panel" id="tab-teachers" role="tabpanel" hidden>

            <!-- Teacher Reviews Admin -->
            <div class="glass-card" id="teacherAdminSection">
                <h2>üßë‚Äçüè´ Teacher Reviews Admin</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Manage teachers/courses and moderate reviews. Some write actions may require running <strong>teacher-admin-rls-policies.sql</strong>.
                </p>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="teacherTotalTeachers">‚Äî</div>
                        <div class="stat-label">Teachers</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="teacherTotalCourses">‚Äî</div>
                        <div class="stat-label">Courses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="teacherTotalReviews">‚Äî</div>
                        <div class="stat-label">Reviews</div>
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="loadTeacherAdminOverview()" style="width: auto; padding: 0.75rem 1rem;">üîÑ Refresh</button>
                    <button class="btn btn-secondary" onclick="loadTeachersAdminList()" style="width: auto; padding: 0.75rem 1rem;">üìã Teachers</button>
                    <button class="btn btn-secondary" onclick="loadCoursesAdminList()" style="width: auto; padding: 0.75rem 1rem;">üìö Courses</button>
                    <button class="btn btn-secondary" onclick="loadCourseTeacherLinks()" style="width: auto; padding: 0.75rem 1rem;">üîó Links</button>
                    <button class="btn btn-secondary" onclick="loadRecentTeacherReviewsAdmin(30)" style="width: auto; padding: 0.75rem 1rem;">üßæ Recent Reviews</button>
                </div>

                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
                    <input id="teacherSearchInput" placeholder="Search teacher (name/department)" style="flex: 1; min-width: 220px; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;" />
                    <button class="btn btn-primary" onclick="promptAddTeacher()" style="width: auto; padding: 0.75rem 1rem;">‚ûï Add Teacher</button>
                    <input id="courseSearchInput" placeholder="Search course (code/name)" style="flex: 1; min-width: 220px; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;" />
                    <button class="btn btn-primary" onclick="promptAddCourse()" style="width: auto; padding: 0.75rem 1rem;">‚ûï Add Course</button>
                    <button class="btn btn-secondary" onclick="promptAddCourseTeacherLink()" style="width: auto; padding: 0.75rem 1rem;">‚ûï Add Link</button>
                </div>

                <div id="teacherAdminTable">
                    <p style="text-align: center; color: var(--text-secondary); padding: 1.25rem;">Use the buttons above to load teachers/courses/reviews.</p>
                </div>
            </div>

                </section>

                <section class="tab-panel" id="tab-analytics" role="tabpanel" hidden>

            <!-- Analytics -->
            <div class="glass-card" id="analyticsSection">
                <h2>üìà Analytics</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    User activity comes from <strong>user_visits</strong>. Page hits come from <strong>page_visits</strong> (requires add-page-visits-table.sql).
                </p>

                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="analyticsTrackedUsers">‚Äî</div>
                        <div class="stat-label">Tracked Users</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="analyticsTotalUserVisits">‚Äî</div>
                        <div class="stat-label">Total User Visits</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="analyticsActive24h">‚Äî</div>
                        <div class="stat-label">Active (24h)</div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="loadAnalyticsSummary()" style="width: 100%; margin-bottom: 1rem;">üîÑ Refresh Analytics</button>
                <div id="pageVisitsTable"></div>
            </div>

                </section>

                <section class="tab-panel" id="tab-trimester" role="tabpanel" hidden>

            <!-- Active Trimester Management -->
            <div class="glass-card" id="settingsSection">
                <h2>üéØ Active Trimester</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    This is the trimester students will submit their GPAs for. Change this when you're ready to accept submissions for a new trimester.
                </p>
                
                <div class="active-trimester-display">
                    <div class="trimester-value" id="activeTrimesterDisplay">
                        Loading...
                    </div>
                    <div class="trimester-note">
                        üìå Currently accepting submissions for this trimester
                    </div>
                </div>

                <label for="newTrimesterSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">
                    Change Active Trimester:
                </label>
                <select id="newTrimesterSelect" class="trimester-select">
                    <option value="Spring 2026">Spring 2026</option>
                    <option value="Fall 2025">Fall 2025</option>
                    <option value="Summer 2025">Summer 2025</option>
                    <option value="Spring 2025">Spring 2025</option>
                    <option value="Fall 2024" selected>Fall 2024</option>
                    <option value="Summer 2024">Summer 2024</option>
                    <option value="Spring 2024">Spring 2024</option>
                </select>
                
                <button class="btn btn-primary" onclick="updateActiveTrimester()" style="width: 100%;">
                    üíæ Update Active Trimester
                </button>
            </div>

                </section>

                <section class="tab-panel" id="tab-scholarship" role="tabpanel" hidden>

            <!-- Statistics Overview -->
            <div class="glass-card" id="overviewSection">
                <h2>üìä Statistics Overview</h2>
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalSubmissions">0</div>
                        <div class="stat-label">Total Submissions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalDepartments">0</div>
                        <div class="stat-label">Active Departments</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgGPA">0.00</div>
                        <div class="stat-label">Average GPA</div>
                    </div>
                </div>
            </div>

            <!-- Department Breakdown -->
            <div class="glass-card" id="departmentSection">
                <h2>üè´ Department Breakdown</h2>
                <div id="departmentStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading statistics...</p>
                    </div>
                </div>
            </div>

            <!-- Recent Submissions -->
            <div class="glass-card" id="submissionsSection">
                <h2>üìã Recent Submissions</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    View and manage the latest scholarship submissions
                </p>
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="loadRecentSubmissions(10)" style="margin-right: 0.5rem;">
                        Show Last 10
                    </button>
                    <button class="btn btn-secondary" onclick="loadRecentSubmissions(50)">
                        Show Last 50
                    </button>
                </div>
                <div id="recentSubmissions">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click a button above to load submissions...</p>
                    </div>
                </div>
            </div>

            <!-- Flagged Submissions Queue -->
            <div class="glass-card" id="flaggedSection">
                <h2>üö© Flagged Submissions</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Review suspicious submissions (requires RLS policy access on <strong>flagged_submissions</strong>).
                </p>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="loadFlaggedSubmissions(false)" style="width: auto; padding: 0.75rem 1rem;">
                        Show Unreviewed
                    </button>
                    <button class="btn btn-secondary" onclick="loadFlaggedSubmissions(true)" style="width: auto; padding: 0.75rem 1rem;">
                        Show All
                    </button>
                </div>
                <div id="flaggedSubmissions">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Click a button above to load flagged items...</p>
                    </div>
                </div>
            </div>

                </section>

                <section class="tab-panel" id="tab-users" role="tabpanel" hidden>

            <!-- User Management -->
            <div class="glass-card" id="userManagement">
                <h2>üë• User Management</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Search and manage individual user submissions
                </p>
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                    <input 
                        type="text" 
                        id="searchEmailInput" 
                        placeholder="Search by email or student ID..."
                        style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;"
                    >
                    <button class="btn btn-primary" onclick="searchUser()">
                        üîç Search
                    </button>
                </div>
                <div id="userSearchResults"></div>
            </div>

            <!-- Registered Users (Directory) -->
            <div class="glass-card" id="usersDirectory">
                <h2>üßæ Registered Users</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    View users, verification status, and visit analytics.
                </p>

                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem;">
                    <input
                        type="text"
                        id="usersSearchInput"
                        placeholder="Search users (email / student id)"
                        style="flex: 1; min-width: 220px; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;"
                    >
                    <button class="btn btn-primary" onclick="loadUsersDirectory()" style="width: auto; padding: 0.75rem 1rem;">
                        üîÑ Refresh
                    </button>
                </div>

                <div id="usersDirectoryTable">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>

                </section>

                <section class="tab-panel" id="tab-export" role="tabpanel" hidden>

            <!-- Export Data -->
            <div class="glass-card" id="exportSection">
                <h2>üì• Export Data</h2>
                <button class="btn btn-export" onclick="exportData()">
                    üì• Download Current Trimester Data (CSV)
                </button>
            </div>

                </section>

                <section class="tab-panel" id="tab-danger" role="tabpanel" hidden>

            <!-- Danger Zone -->
            <div class="glass-card" id="dangerSection">
                <div class="danger-zone">
                    <h3>üö® Danger Zone</h3>
                    <div class="warning-text">
                        <strong>‚ö†Ô∏è Warning:</strong> These actions are permanent and cannot be undone. 
                        Use only when transitioning to a new trimester.
                    </div>
                    
                    <button class="btn btn-danger" onclick="resetTrimester()" style="margin-bottom: 1rem;">
                        üîÑ Reset Current Trimester Data
                    </button>
                    
                    <button class="btn btn-danger" onclick="clearOldOTPs()">
                        üóëÔ∏è Clear Old Verification Codes
                    </button>
                </div>
            </div>

                </section>
            </div>

            <div class="back-link">
                <a href="index.html">‚Üê Back to Home</a>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content">
            <h3 id="modalTitle">üéØ Confirm Action</h3>
            <p id="modalMessage">Are you sure you want to proceed?</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">‚ùå Cancel</button>
                <button class="btn btn-primary" id="modalConfirmBtn">‚úÖ Confirm</button>
            </div>
        </div>
    </div>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        // ============================================
        // ADMIN AUTH (SUPABASE AUTH + admin_roles)
        // ============================================

        async function ensureAdminAccess() {
            // Assumes user is authenticated.
            // If the user doesn't have a row in public.admin_roles, deny access.
            const { data, error } = await window.supabaseClient
                .from('admin_roles')
                .select('role')
                .eq('user_id', (await window.supabaseClient.auth.getUser()).data.user?.id)
                .single();

            // PGRST116 => no row
            if (error && error.code !== 'PGRST116') {
                throw error;
            }

            if (!data) {
                // Not an admin
                await window.supabaseClient.auth.signOut();
                showAlert('‚ùå Access denied', 'Your account is not listed in admin_roles.');
                return false;
            }

            return true;
        }

        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            initAdminTabs();
            setAdminTab(getAdminTabFromHash(), { updateHash: false, focus: false });
        }

        function showLoginScreen() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            const pwd = document.getElementById('adminPasswordInput');
            if (pwd) pwd.value = '';
        }

        async function adminSignIn() {
            const email = (document.getElementById('adminEmailInput')?.value || '').trim();
            const password = document.getElementById('adminPasswordInput')?.value || '';

            if (!email || !password) {
                showAlert('‚ö†Ô∏è Missing info', 'Enter your admin email and password.');
                return;
            }

            try {
                const { error } = await window.supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                const ok = await ensureAdminAccess();
                if (!ok) {
                    showLoginScreen();
                    return;
                }

                showAdminPanel();
                loadAdminData();
                loadSiteOverview();
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('adminSignIn error:', e);
                showAlert('‚ùå Sign-in failed', e?.message || String(e));
            }
        }

        async function logoutAdmin() {
            try {
                await window.supabaseClient.auth.signOut();
            } finally {
                showLoginScreen();
            }
        }

        // Enter-to-submit
        document.getElementById('adminPasswordInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') adminSignIn();
        });

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        
        function showModal(title, message, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            
            // Show cancel button for confirmations
            const cancelBtn = document.querySelector('.modal-buttons .btn-secondary');
            if (cancelBtn) cancelBtn.style.display = 'flex';
            
            // Update confirm button text
            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.textContent = '‚úÖ Confirm';
            
            // Remove old listener and add new one
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                closeModal();
                onConfirm();
            });
        }
        
        function showAlert(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            
            // Hide cancel button for alerts
            const cancelBtn = document.querySelector('.modal-buttons .btn-secondary');
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            // Update confirm button text to OK
            const confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.textContent = '‚úÖ OK';
            
            // Remove old listener and add new one that just closes
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            newConfirmBtn.addEventListener('click', () => {
                closeModal();
            });
        }
        
        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
        }
        
        // Close modal on outside click
        document.getElementById('confirmModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                closeModal();
            }
        });

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function getCurrentTrimester() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth(); // 0-11
            
            if (month >= 0 && month <= 3) {
                return `Spring ${year}`;
            } else if (month >= 4 && month <= 7) {
                return `Summer ${year}`;
            } else {
                return `Fall ${year}`;
            }
        }

        // ============================================
        // LOAD ADMIN DATA
        // ============================================
        
        async function loadAdminData() {
            // Load active trimester from database
            const activeTrimester = await loadActiveTrimester();
            
            try {
                // Fetch all submissions for ACTIVE trimester (not current)
                const { data: submissions, error } = await window.supabaseClient
                    .from('scholarship_submissions')
                    .select('*')
                    .eq('trimester', activeTrimester);
                
                if (error) throw error;
                
                // Calculate statistics
                const total = submissions.length;
                const departments = {};
                let totalGPA = 0;
                
                submissions.forEach(sub => {
                    departments[sub.department] = (departments[sub.department] || 0) + 1;
                    totalGPA += parseFloat(sub.last_trimester_gpa);
                });
                
                const avgGPA = total > 0 ? (totalGPA / total).toFixed(2) : '0.00';
                
                // Update overview stats
                document.getElementById('totalSubmissions').textContent = total;
                document.getElementById('totalDepartments').textContent = Object.keys(departments).length;
                document.getElementById('avgGPA').textContent = avgGPA;
                
                // Update department table
                let tableHTML = '<table class="dept-table"><thead><tr><th>Department</th><th>Students</th><th>Percentage</th></tr></thead><tbody>';
                
                for (const [dept, count] of Object.entries(departments).sort((a, b) => b[1] - a[1])) {
                    const percentage = ((count / total) * 100).toFixed(1);
                    tableHTML += `
                        <tr>
                            <td><strong>${dept}</strong></td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }
                
                tableHTML += '</tbody></table>';
                document.getElementById('departmentStats').innerHTML = tableHTML;

                // Keep users directory fresh when admin data is loaded
                loadUsersDirectory();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                document.getElementById('departmentStats').innerHTML = 
                    '<p style="color: var(--danger); text-align: center;">Error loading data. Check console for details.</p>';
            }
        }

        // ============================================
        // SITE OVERVIEW (WHOLE HUB)
        // ============================================

        async function loadSiteOverview() {
            try {
                const { data: users, error: usersError } = await window.supabaseClient
                    .from('users')
                    .select('id, email_verified')
                    .limit(2000);

                if (usersError) throw usersError;

                const totalUsers = users?.length || 0;
                const verifiedUsers = (users || []).filter(u => u.email_verified).length;

                const totalEl = document.getElementById('siteTotalUsers');
                const verifiedEl = document.getElementById('siteVerifiedUsers');
                if (totalEl) totalEl.textContent = totalUsers.toLocaleString();
                if (verifiedEl) verifiedEl.textContent = verifiedUsers.toLocaleString();

                // Teacher review stats (schema might not be installed)
                const { count: reviewsCount, error: rErr } = await window.supabaseClient
                    .from('teacher_reviews')
                    .select('*', { count: 'exact', head: true });

                if (!rErr) {
                    const reviewsEl = document.getElementById('siteTeacherReviews');
                    if (reviewsEl) reviewsEl.textContent = (reviewsCount ?? 0).toLocaleString();
                }
            } catch (e) {
                console.warn('loadSiteOverview failed:', e);
            }
        }

        // ============================================
        // TEACHER REVIEWS ADMIN
        // ============================================

        function setTeacherAdminTable(html) {
            const container = document.getElementById('teacherAdminTable');
            if (container) container.innerHTML = html;
        }

        async function loadTeacherAdminOverview() {
            try {
                const [{ count: teachersCount, error: tErr }, { count: coursesCount, error: cErr }, { count: reviewsCount, error: rErr }] = await Promise.all([
                    window.supabaseClient.from('teachers').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.from('courses').select('*', { count: 'exact', head: true }),
                    window.supabaseClient.from('teacher_reviews').select('*', { count: 'exact', head: true })
                ]);

                if (tErr) throw tErr;
                if (cErr) throw cErr;
                if (rErr) throw rErr;

                const tEl = document.getElementById('teacherTotalTeachers');
                const cEl = document.getElementById('teacherTotalCourses');
                const rEl = document.getElementById('teacherTotalReviews');
                if (tEl) tEl.textContent = (teachersCount ?? 0).toLocaleString();
                if (cEl) cEl.textContent = (coursesCount ?? 0).toLocaleString();
                if (rEl) rEl.textContent = (reviewsCount ?? 0).toLocaleString();
            } catch (e) {
                console.warn('loadTeacherAdminOverview failed:', e);
            }
        }

        async function loadTeachersAdminList() {
            const q = (document.getElementById('teacherSearchInput')?.value || '').trim();
            setTeacherAdminTable('<div class="loading"><div class="spinner"></div><p>Loading teachers...</p></div>');

            try {
                let query = window.supabaseClient
                    .from('teachers')
                    .select('id, name, department, total_reviews, average_rating, created_at')
                    .order('total_reviews', { ascending: false })
                    .limit(200);

                if (q) {
                    query = query.or(`name.ilike.%${q}%,department.ilike.%${q}%`);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    setTeacherAdminTable('<p style="text-align:center; color: var(--text-secondary); padding: 1.25rem;">No teachers found.</p>');
                    return;
                }

                let html = '<div class="table-scroll"><table class="dept-table"><thead><tr><th>Name</th><th>Department</th><th>Reviews</th><th>Avg</th><th>Actions</th></tr></thead><tbody>';
                for (const t of data) {
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(t.name)}</strong></td>
                            <td><span class="chip muted">${escapeHtml(t.department)}</span></td>
                            <td>${t.total_reviews ?? 0}</td>
                            <td>${t.average_rating ?? 0}</td>
                            <td style="min-width: 240px;">
                                <button class="btn btn-secondary" onclick="promptEditTeacher('${t.id}', '${escapeJs(t.name)}', '${escapeJs(t.department)}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteTeacherAdmin('${t.id}', '${escapeJs(t.name)}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex; margin-left: 0.5rem;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';
                setTeacherAdminTable(html);
            } catch (e) {
                console.error('loadTeachersAdminList error:', e);
                setTeacherAdminTable('<p style="text-align:center; color: var(--danger); padding: 1.25rem;">Failed to load teachers. Ensure teacher schema is installed.</p>');
            }
        }

        async function loadCoursesAdminList() {
            const q = (document.getElementById('courseSearchInput')?.value || '').trim();
            setTeacherAdminTable('<div class="loading"><div class="spinner"></div><p>Loading courses...</p></div>');

            try {
                let query = window.supabaseClient
                    .from('courses')
                    .select('code, name, department, credits, created_at')
                    .order('code', { ascending: true })
                    .limit(250);

                if (q) {
                    query = query.or(`code.ilike.%${q}%,name.ilike.%${q}%,department.ilike.%${q}%`);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    setTeacherAdminTable('<p style="text-align:center; color: var(--text-secondary); padding: 1.25rem;">No courses found.</p>');
                    return;
                }

                let html = '<div class="table-scroll"><table class="dept-table"><thead><tr><th>Code</th><th>Name</th><th>Department</th><th>Credits</th><th>Actions</th></tr></thead><tbody>';
                for (const c of data) {
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(c.code)}</strong></td>
                            <td>${escapeHtml(c.name)}</td>
                            <td><span class="chip muted">${escapeHtml(c.department)}</span></td>
                            <td>${c.credits ?? 3}</td>
                            <td style="min-width: 240px;">
                                <button class="btn btn-secondary" onclick="promptEditCourse('${escapeJs(c.code)}', '${escapeJs(c.name)}', '${escapeJs(c.department)}', ${c.credits ?? 3})" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">‚úèÔ∏è Edit</button>
                                <button class="btn btn-danger" onclick="deleteCourseAdmin('${escapeJs(c.code)}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex; margin-left: 0.5rem;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';
                setTeacherAdminTable(html);
            } catch (e) {
                console.error('loadCoursesAdminList error:', e);
                setTeacherAdminTable('<p style="text-align:center; color: var(--danger); padding: 1.25rem;">Failed to load courses. Ensure teacher schema is installed.</p>');
            }
        }

        async function loadCourseTeacherLinks() {
            setTeacherAdminTable('<div class="loading"><div class="spinner"></div><p>Loading links...</p></div>');
            try {
                const { data, error } = await window.supabaseClient
                    .from('course_teachers')
                    .select('id, course_code, teacher:teachers(id,name,department), course:courses(code,name,department)')
                    .order('created_at', { ascending: false })
                    .limit(200);

                if (error) throw error;

                if (!data || data.length === 0) {
                    setTeacherAdminTable('<p style="text-align:center; color: var(--text-secondary); padding: 1.25rem;">No course-teacher links found.</p>');
                    return;
                }

                let html = '<div class="table-scroll"><table class="dept-table"><thead><tr><th>Course</th><th>Teacher</th><th>Actions</th></tr></thead><tbody>';
                for (const link of data) {
                    const course = link.course || {};
                    const teacher = link.teacher || {};
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(link.course_code)}</strong><br><span style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(course.name || '')}</span></td>
                            <td><strong>${escapeHtml(teacher.name || '‚Äî')}</strong><br><span style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(teacher.department || '')}</span></td>
                            <td style="min-width: 160px;">
                                <button class="btn btn-danger" onclick="deleteCourseTeacherLinkAdmin('${link.id}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">üóëÔ∏è Remove</button>
                            </td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';
                setTeacherAdminTable(html);
            } catch (e) {
                console.error('loadCourseTeacherLinks error:', e);
                setTeacherAdminTable('<p style="text-align:center; color: var(--danger); padding: 1.25rem;">Failed to load links. Ensure teacher schema is installed.</p>');
            }
        }

        async function loadRecentTeacherReviewsAdmin(limit = 30) {
            setTeacherAdminTable('<div class="loading"><div class="spinner"></div><p>Loading reviews...</p></div>');
            try {
                const { data, error } = await window.supabaseClient
                    .from('teacher_reviews')
                    .select('id, created_at, overall_rating, review_text, helpful_count, not_helpful_count, teacher:teachers(name,department), course:courses(code,name)')
                    .order('created_at', { ascending: false })
                    .limit(limit);

                if (error) throw error;

                if (!data || data.length === 0) {
                    setTeacherAdminTable('<p style="text-align:center; color: var(--text-secondary); padding: 1.25rem;">No reviews found.</p>');
                    return;
                }

                let html = '<div class="table-scroll"><table class="dept-table"><thead><tr><th>Teacher</th><th>Course</th><th>Rating</th><th>Text</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                for (const r of data) {
                    const teacher = r.teacher || {};
                    const course = r.course || {};
                    const created = r.created_at ? getTimeAgo(parseSupabaseTimestamp(r.created_at) || new Date(r.created_at)) : '‚Äî';
                    const text = (r.review_text || '').trim();
                    const shortText = text.length > 120 ? text.slice(0, 120) + '‚Ä¶' : text;
                    html += `
                        <tr>
                            <td><strong>${escapeHtml(teacher.name || '‚Äî')}</strong><br><span style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(teacher.department || '')}</span></td>
                            <td>${escapeHtml(course.code || '‚Äî')}<br><span style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(course.name || '')}</span></td>
                            <td><span class="chip success">${r.overall_rating}‚òÖ</span></td>
                            <td style="font-size: 0.9rem; color: var(--text-secondary);">${escapeHtml(shortText || '‚Äî')}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${escapeHtml(created)}</td>
                            <td style="min-width: 160px;">
                                <button class="btn btn-danger" onclick="deleteTeacherReviewAdmin('${r.id}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">üóëÔ∏è Delete</button>
                            </td>
                        </tr>
                    `;
                }
                html += '</tbody></table></div>';
                setTeacherAdminTable(html);
            } catch (e) {
                console.error('loadRecentTeacherReviewsAdmin error:', e);
                setTeacherAdminTable('<p style="text-align:center; color: var(--danger); padding: 1.25rem;">Failed to load reviews. Ensure teacher schema is installed.</p>');
            }
        }

        function promptAddTeacher() {
            const name = prompt('Teacher name:');
            if (!name) return;
            const department = prompt('Department (e.g., BSCSE):') || '';
            addTeacherAdmin(name.trim(), department.trim());
        }

        async function addTeacherAdmin(name, department) {
            try {
                const { error } = await window.supabaseClient
                    .from('teachers')
                    .insert({ name, department });
                if (error) throw error;
                showAlert('‚úÖ Added', 'Teacher created.');
                loadTeachersAdminList();
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('addTeacherAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to add teacher. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        function promptEditTeacher(id, currentName, currentDepartment) {
            const name = prompt('Teacher name:', currentName);
            if (!name) return;
            const department = prompt('Department:', currentDepartment) || '';
            editTeacherAdmin(id, name.trim(), department.trim());
        }

        async function editTeacherAdmin(id, name, department) {
            try {
                const { error } = await window.supabaseClient
                    .from('teachers')
                    .update({ name, department, updated_at: new Date().toISOString() })
                    .eq('id', id);
                if (error) throw error;
                showAlert('‚úÖ Updated', 'Teacher updated.');
                loadTeachersAdminList();
            } catch (e) {
                console.error('editTeacherAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to update teacher. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        async function deleteTeacherAdmin(id, name) {
            if (!confirm(`Delete teacher "${name}"?\n\nThis will cascade-delete linked reviews/links.`)) return;
            try {
                const { error } = await window.supabaseClient
                    .from('teachers')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                showAlert('‚úÖ Deleted', 'Teacher deleted.');
                loadTeachersAdminList();
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('deleteTeacherAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to delete teacher. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        function promptAddCourse() {
            const code = prompt('Course code (e.g., CSE 1111):');
            if (!code) return;
            const name = prompt('Course name:') || '';
            const department = prompt('Department (e.g., BSCSE):') || '';
            const creditsRaw = prompt('Credits:', '3') || '3';
            const credits = parseInt(creditsRaw, 10);
            addCourseAdmin(code.trim(), name.trim(), department.trim(), Number.isFinite(credits) ? credits : 3);
        }

        async function addCourseAdmin(code, name, department, credits) {
            try {
                const { error } = await window.supabaseClient
                    .from('courses')
                    .insert({ code, name, department, credits });
                if (error) throw error;
                showAlert('‚úÖ Added', 'Course created.');
                loadCoursesAdminList();
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('addCourseAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to add course. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        function promptEditCourse(code, currentName, currentDepartment, currentCredits) {
            const name = prompt('Course name:', currentName);
            if (!name) return;
            const department = prompt('Department:', currentDepartment) || '';
            const creditsRaw = prompt('Credits:', String(currentCredits ?? 3)) || String(currentCredits ?? 3);
            const credits = parseInt(creditsRaw, 10);
            editCourseAdmin(code, name.trim(), department.trim(), Number.isFinite(credits) ? credits : 3);
        }

        async function editCourseAdmin(code, name, department, credits) {
            try {
                const { error } = await window.supabaseClient
                    .from('courses')
                    .update({ name, department, credits })
                    .eq('code', code);
                if (error) throw error;
                showAlert('‚úÖ Updated', 'Course updated.');
                loadCoursesAdminList();
            } catch (e) {
                console.error('editCourseAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to update course. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        async function deleteCourseAdmin(code) {
            if (!confirm(`Delete course ${code}?\n\nThis will cascade-delete links/reviews tied to it.`)) return;
            try {
                const { error } = await window.supabaseClient
                    .from('courses')
                    .delete()
                    .eq('code', code);
                if (error) throw error;
                showAlert('‚úÖ Deleted', 'Course deleted.');
                loadCoursesAdminList();
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('deleteCourseAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to delete course. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        async function promptAddCourseTeacherLink() {
            try {
                const { data: teachers, error: tErr } = await window.supabaseClient
                    .from('teachers')
                    .select('id, name, department')
                    .order('name', { ascending: true })
                    .limit(200);
                if (tErr) throw tErr;

                const { data: courses, error: cErr } = await window.supabaseClient
                    .from('courses')
                    .select('code, name')
                    .order('code', { ascending: true })
                    .limit(250);
                if (cErr) throw cErr;

                if (!teachers?.length || !courses?.length) {
                    showAlert('‚ÑπÔ∏è Info', 'Need at least one teacher and one course to create a link.');
                    return;
                }

                const teacherList = teachers.slice(0, 15).map(t => `${t.name} (${t.department}) ‚Äî ${t.id}`).join('\n');
                const courseList = courses.slice(0, 15).map(c => `${c.code} ‚Äî ${c.name}`).join('\n');

                const teacherId = prompt(`Teacher UUID (copy/paste). First 15 teachers:\n\n${teacherList}\n\nEnter teacher UUID:`);
                if (!teacherId) return;
                const courseCode = prompt(`Course code. First 15 courses:\n\n${courseList}\n\nEnter course code:`);
                if (!courseCode) return;

                await addCourseTeacherLinkAdmin(courseCode.trim(), teacherId.trim());
            } catch (e) {
                console.error('promptAddCourseTeacherLink error:', e);
                showAlert('‚ùå Error', 'Failed to load teachers/courses list: ' + (e?.message || e));
            }
        }

        async function addCourseTeacherLinkAdmin(courseCode, teacherId) {
            try {
                const { error } = await window.supabaseClient
                    .from('course_teachers')
                    .insert({ course_code: courseCode, teacher_id: teacherId });
                if (error) throw error;
                showAlert('‚úÖ Added', 'Link created.');
                loadCourseTeacherLinks();
            } catch (e) {
                console.error('addCourseTeacherLinkAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to add link. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        async function deleteCourseTeacherLinkAdmin(id) {
            if (!confirm('Remove this course-teacher link?')) return;
            try {
                const { error } = await window.supabaseClient
                    .from('course_teachers')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                showAlert('‚úÖ Removed', 'Link removed.');
                loadCourseTeacherLinks();
            } catch (e) {
                console.error('deleteCourseTeacherLinkAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to remove link. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        async function deleteTeacherReviewAdmin(id) {
            if (!confirm('Delete this review?')) return;
            try {
                const { error } = await window.supabaseClient
                    .from('teacher_reviews')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                showAlert('‚úÖ Deleted', 'Review deleted.');
                loadRecentTeacherReviewsAdmin(30);
                loadTeacherAdminOverview();
            } catch (e) {
                console.error('deleteTeacherReviewAdmin error:', e);
                showAlert('‚ùå Error', 'Failed to delete review. If this is an RLS error, run teacher-admin-rls-policies.sql.\n\n' + (e?.message || e));
            }
        }

        // ============================================
        // ANALYTICS
        // ============================================

        async function loadAnalyticsSummary() {
            try {
                // user_visits summary
                const { data, error } = await window.supabaseClient
                    .from('user_visits')
                    .select('visit_count, last_visited_at')
                    .limit(2000);

                if (error) throw error;

                const rows = data?.length || 0;
                const totalVisits = (data || []).reduce((acc, r) => acc + (r.visit_count || 0), 0);

                const since = new Date(Date.now() - 24 * 60 * 60 * 1000);
                const active24h = (data || []).filter(r => {
                    const d = r.last_visited_at ? parseSupabaseTimestamp(r.last_visited_at) : null;
                    return d && d >= since;
                }).length;

                const trackedEl = document.getElementById('analyticsTrackedUsers');
                const totalEl = document.getElementById('analyticsTotalUserVisits');
                const activeEl = document.getElementById('analyticsActive24h');
                if (trackedEl) trackedEl.textContent = rows.toLocaleString();
                if (totalEl) totalEl.textContent = totalVisits.toLocaleString();
                if (activeEl) activeEl.textContent = active24h.toLocaleString();

                await loadPageVisitsAdminTable();
            } catch (e) {
                console.warn('loadAnalyticsSummary failed:', e);
            }
        }

        async function loadPageVisitsAdminTable() {
            const container = document.getElementById('pageVisitsTable');
            if (container) container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading page visits...</p></div>';

            try {
                const { data, error } = await window.supabaseClient
                    .from('page_visits')
                    .select('page_name, visit_count, last_updated')
                    .order('visit_count', { ascending: false })
                    .limit(100);

                if (error) throw error;

                if (!data || data.length === 0) {
                    if (container) container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 1.25rem;">No page visits found.</p>';
                    return;
                }

                let html = '<div class="table-scroll"><table class="dept-table"><thead><tr><th>Page</th><th>Visits</th><th>Updated</th></tr></thead><tbody>';
                for (const row of data) {
                    const updated = row.last_updated ? getTimeAgo(parseSupabaseTimestamp(row.last_updated) || new Date(row.last_updated)) : '‚Äî';
                    html += `<tr><td><strong>${escapeHtml(row.page_name)}</strong></td><td>${(row.visit_count ?? 0).toLocaleString()}</td><td style="font-size:0.85rem; color: var(--text-secondary);">${escapeHtml(updated)}</td></tr>`;
                }
                html += '</tbody></table></div>';
                if (container) container.innerHTML = html;
            } catch (e) {
                console.warn('page_visits load failed:', e);
                if (container) container.innerHTML = '<p style="text-align:center; color: var(--danger); padding: 1.25rem;">Unable to load page_visits. Run add-page-visits-table.sql.</p>';
            }
        }

        // ============================================
        // USERS DIRECTORY (REGISTERED USERS)
        // ============================================

        async function loadUsersDirectory() {
            const container = document.getElementById('usersDirectoryTable');
            const queryText = (document.getElementById('usersSearchInput')?.value || '').trim();

            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>';

            try {
                // Fetch users (note: visit stats come from user_visits)
                // If you haven't created user_visits yet, run add-user-visits-table.sql
                let query = window.supabaseClient
                    .from('users')
                    .select('id, email, student_id, email_verified, verified_at, created_at, visits:user_visits(visit_count,last_visited_at,last_page)')
                    .order('created_at', { ascending: false })
                    .limit(200);

                if (queryText) {
                    const isLikelyStudentId = /^[0-9\-\s]+$/.test(queryText);
                    query = isLikelyStudentId
                        ? query.ilike('student_id', `%${queryText}%`)
                        : query.ilike('email', `%${queryText}%`);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 1.5rem;">No users found.</p>';
                    return;
                }

                let html = `
                    <div class="table-scroll">
                        <table class="dept-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Email</th>
                                    <th>Student ID</th>
                                    <th>Visits</th>
                                    <th>Last Visited</th>
                                    <th>Last Page</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.forEach(u => {
                    const visits = Array.isArray(u.visits) ? u.visits[0] : u.visits;
                    const visitCount = visits?.visit_count ?? 0;
                    const lastVisitedDate = visits?.last_visited_at ? parseSupabaseTimestamp(visits.last_visited_at) : null;
                    const lastVisited = lastVisitedDate ? getTimeAgo(lastVisitedDate) : '‚Äî';
                    const lastPage = visits?.last_page || '‚Äî';
                    const statusChip = u.email_verified
                        ? '<span class="chip success">Verified</span>'
                        : '<span class="chip warning">Unverified</span>';

                    html += `
                        <tr>
                            <td>${statusChip}</td>
                            <td style="font-size: 0.85rem;">${escapeHtml(u.email)}</td>
                            <td><strong>${escapeHtml(u.student_id)}</strong></td>
                            <td>${visitCount}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${escapeHtml(lastVisited)}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${escapeHtml(lastPage)}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '‚Äî'}</td>
                            <td style="min-width: 310px;">
                                <button class="btn btn-secondary" onclick="toggleUserVerified('${u.id}', ${u.email_verified ? 'true' : 'false'})" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">
                                    ${u.email_verified ? '‚Ü©Ô∏è Unverify' : '‚úÖ Verify'}
                                </button>
                                <button class="btn btn-secondary" onclick="resetUserVisits('${u.id}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex; margin-left: 0.5rem;">
                                    ‚ôªÔ∏è Reset visits
                                </button>
                                <button class="btn btn-danger" onclick="deleteUser('${u.id}', '${escapeJs(u.email)}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex; margin-left: 0.5rem;">
                                    üóëÔ∏è Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;

            } catch (error) {
                console.error('Users directory error:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem;">
                        <p style="color: var(--danger); font-weight: 800;">Unable to load users</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">If this mentions <strong>user_visits</strong>, run add-user-visits-table.sql in Supabase first.</p>
                    </div>
                `;
            }
        }

        async function toggleUserVerified(userId, currentVerified) {
            const nextVerified = !currentVerified;
            try {
                const { error } = await window.supabaseClient
                    .from('users')
                    .update({
                        email_verified: nextVerified,
                        verified_at: nextVerified ? new Date().toISOString() : null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                showAlert('‚úÖ Updated', `User marked as ${nextVerified ? 'verified' : 'unverified'}.`);
                loadUsersDirectory();
            } catch (error) {
                console.error('toggleUserVerified error:', error);
                showAlert('‚ùå Error', 'Failed to update user: ' + error.message);
            }
        }

        async function resetUserVisits(userId) {
            if (!confirm('Reset visit count for this user?')) return;

            const nowIso = new Date().toISOString();
            try {
                // If row exists, reset; if not, insert a zero row
                const { data: existing, error: fetchError } = await window.supabaseClient
                    .from('user_visits')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single();

                const missing = fetchError && fetchError.code === 'PGRST116';
                if (fetchError && !missing) throw fetchError;

                const { error } = missing
                    ? await window.supabaseClient
                        .from('user_visits')
                        .insert({ user_id: userId, visit_count: 0, first_visited_at: nowIso, last_visited_at: nowIso, last_page: 'admin-reset', updated_at: nowIso })
                    : await window.supabaseClient
                        .from('user_visits')
                        .update({ visit_count: 0, last_visited_at: nowIso, last_page: 'admin-reset', updated_at: nowIso })
                        .eq('user_id', userId);

                if (error) throw error;

                showAlert('‚úÖ Updated', 'Visit stats reset.');
                loadUsersDirectory();
            } catch (error) {
                console.error('resetUserVisits error:', error);
                showAlert('‚ùå Error', 'Failed to reset visits: ' + error.message);
            }
        }

        async function deleteUser(userId, email) {
            if (!confirm(`Delete user ${email}?\n\nThis will also delete linked scholarship submissions (cascade).`)) return;

            try {
                const { error } = await window.supabaseClient
                    .from('users')
                    .delete()
                    .eq('id', userId);

                if (error) throw error;

                showAlert('‚úÖ Deleted', `User ${email} deleted.`);
                loadUsersDirectory();
            } catch (error) {
                console.error('deleteUser error:', error);
                showAlert('‚ùå Error', 'Failed to delete user: ' + error.message);
            }
        }

        // ============================================
        // ACTIVE TRIMESTER MANAGEMENT
        // ============================================
        
        async function loadActiveTrimester() {
            try {
                const { data, error } = await window.supabaseClient
                    .from('app_settings')
                    .select('value')
                    .eq('key', 'active_trimester')
                    .single();
                
                if (error) {
                    console.error('Error loading active trimester:', error);
                    // If table doesn't exist or no data, set default
                    document.getElementById('activeTrimesterDisplay').textContent = 'Fall 2024';
                    document.getElementById('newTrimesterSelect').value = 'Fall 2024';
                    const mini = document.getElementById('activeTrimesterMini');
                    if (mini) mini.textContent = 'Fall 2024';
                    return 'Fall 2024';
                }
                
                const activeTrimester = data.value;
                console.log('‚úÖ Loaded active trimester:', activeTrimester);
                document.getElementById('activeTrimesterDisplay').textContent = activeTrimester;
                document.getElementById('newTrimesterSelect').value = activeTrimester;
                const mini = document.getElementById('activeTrimesterMini');
                if (mini) mini.textContent = activeTrimester;
                
                return activeTrimester;
                
            } catch (error) {
                console.error('Error loading active trimester:', error);
                document.getElementById('activeTrimesterDisplay').textContent = 'Error loading';
                return null;
            }
        }
        
        async function updateActiveTrimester() {
            const newTrimester = document.getElementById('newTrimesterSelect').value;
            const currentTrimester = document.getElementById('activeTrimesterDisplay').textContent;
            
            if (newTrimester === currentTrimester) {
                showAlert(
                    'üí° No Change',
                    `The active trimester is already set to ${newTrimester}.`
                );
                return;
            }
            
            showModal(
                'üéØ Change Active Trimester?',
                `Change active trimester from "${currentTrimester}" to "${newTrimester}"?\n\nStudents will start submitting GPAs for ${newTrimester}.`,
                async () => {
                    try {
                        console.log('üîÑ Attempting to update trimester to:', newTrimester);
                        
                        // First, check if the row exists
                        const { data: existingData, error: checkError } = await window.supabaseClient
                            .from('app_settings')
                            .select('key')
                            .eq('key', 'active_trimester')
                            .single();
                        
                        console.log('üìä Existing data:', existingData, 'Error:', checkError);
                        
                        let updateError;
                        
                        if (checkError && checkError.code === 'PGRST116') {
                            // Row doesn't exist, insert it
                            console.log('‚ûï Row not found, inserting...');
                            const { error: insertError } = await window.supabaseClient
                                .from('app_settings')
                                .insert({ 
                                    key: 'active_trimester',
                                    value: newTrimester, 
                                    updated_at: new Date().toISOString() 
                                });
                            updateError = insertError;
                        } else {
                            // Row exists, update it
                            console.log('‚úèÔ∏è Row found, updating...');
                            const { error } = await window.supabaseClient
                                .from('app_settings')
                                .update({ 
                                    value: newTrimester, 
                                    updated_at: new Date().toISOString() 
                                })
                                .eq('key', 'active_trimester');
                            updateError = error;
                        }
                        
                        if (updateError) {
                            console.error('‚ùå Update/Insert error:', updateError);
                            throw updateError;
                        }
                        
                        console.log('‚úÖ Database updated successfully!');
                        
                        // Update display immediately
                        document.getElementById('activeTrimesterDisplay').textContent = newTrimester;
                        const mini = document.getElementById('activeTrimesterMini');
                        if (mini) mini.textContent = newTrimester;
                        
                        // Reload all admin data to reflect new trimester stats
                        await loadAdminData();
                        
                        // Show success message
                        showAlert(
                            '‚úÖ Success!',
                            `Active trimester updated to ${newTrimester}!\n\nStudents can now submit GPAs for this trimester.`
                        );
                        
                    } catch (error) {
                        console.error('‚ùå Update error:', error);
                        showAlert(
                            '‚ùå Error',
                            'Failed to update active trimester: ' + error.message
                        );
                    }
                }
            );
        }

        // ============================================
        // EXPORT DATA
        // ============================================
        
        async function exportData() {
            // Get active trimester from database
            const trimesterElement = document.getElementById('activeTrimesterDisplay');
            const trimester = trimesterElement ? trimesterElement.textContent : 'Unknown';
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('scholarship_submissions')
                    .select('*')
                    .eq('trimester', trimester);
                
                if (error) throw error;
                
                if (data.length === 0) {
                    alert('No data to export for ' + trimester);
                    return;
                }
                
                // Convert to CSV
                const headers = ['Email', 'Student ID', 'Department', 'Trimester', 'Last GPA', 'CGPA', 'Submitted At'];
                const csvRows = [headers.join(',')];
                
                data.forEach(row => {
                    const values = [
                        row.email,
                        row.student_id,
                        row.department,
                        row.trimester,
                        row.last_trimester_gpa,
                        row.overall_cgpa,
                        new Date(row.submitted_at).toLocaleString()
                    ];
                    csvRows.push(values.map(v => `"${v}"`).join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                // Download
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `scholarship-data-${trimester.replace(' ', '-')}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                alert('‚úÖ Data exported successfully!');
                
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå Error exporting data: ' + error.message);
            }
        }

        // ============================================
        // RESET TRIMESTER
        // ============================================
        
        async function resetTrimester() {
            // Get active trimester from display
            const trimesterElement = document.getElementById('activeTrimesterDisplay');
            const trimester = trimesterElement ? trimesterElement.textContent : 'Unknown';
            
            if (!confirm(`‚ö†Ô∏è Are you ABSOLUTELY SURE you want to DELETE ALL submissions for ${trimester}?\n\nThis will permanently remove all student data for this trimester.\n\nClick OK to continue or Cancel to abort.`)) {
                return;
            }
            
            if (!confirm(`üö® FINAL WARNING!\n\nYou are about to delete ${document.getElementById('totalSubmissions').textContent} submissions for ${trimester}.\n\nThis action CANNOT be undone!\n\nClick OK to proceed with deletion.`)) {
                return;
            }
            
            try {
                // Delete submissions
                const { error: subError } = await window.supabaseClient
                    .from('scholarship_submissions')
                    .delete()
                    .eq('trimester', trimester);
                
                if (subError) throw subError;
                
                // Delete department stats
                const { error: statsError } = await window.supabaseClient
                    .from('department_stats')
                    .delete()
                    .eq('trimester', trimester);
                
                if (statsError) console.warn('Stats deletion warning:', statsError);
                
                alert(`‚úÖ Successfully reset ${trimester} data!\n\nAll submissions have been deleted.`);
                
                // Reload data
                loadAdminData();
                
            } catch (error) {
                console.error('Reset error:', error);
                alert('‚ùå Error resetting trimester: ' + error.message);
            }
        }

        // ============================================
        // LOAD RECENT SUBMISSIONS
        // ============================================
        
        async function loadRecentSubmissions(limit = 10) {
            const container = document.getElementById('recentSubmissions');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading submissions...</p></div>';
            
            try {
                const activeTrimester = document.getElementById('activeTrimesterDisplay').textContent;
                
                const { data: submissions, error } = await window.supabaseClient
                    .from('scholarship_submissions')
                    .select('*')
                    .eq('trimester', activeTrimester)
                    .order('submitted_at', { ascending: false })
                    .limit(limit);
                
                if (error) throw error;
                
                if (submissions.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No submissions found for ' + activeTrimester + '</p>';
                    return;
                }
                
                let tableHTML = `
                    <div style="overflow-x: auto;">
                        <table class="dept-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Student ID</th>
                                    <th>Department</th>
                                    <th>Last GPA</th>
                                    <th>CGPA</th>
                                    <th>Submitted</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                submissions.forEach(sub => {
                    const date = new Date(sub.submitted_at);
                    const timeAgo = getTimeAgo(date);
                    
                    tableHTML += `
                        <tr>
                            <td style="font-size: 0.85rem;">${sub.email}</td>
                            <td><strong>${sub.student_id}</strong></td>
                            <td><span style="background: rgba(99, 102, 241, 0.2); padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.85rem;">${sub.department}</span></td>
                            <td><strong style="color: var(--primary);">${sub.last_trimester_gpa}</strong></td>
                            <td>${sub.overall_cgpa}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${timeAgo}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteSubmission('${sub.id}', '${sub.email}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table></div>';
                container.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                container.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading submissions</p>';
            }
        }
        
        // Helper function to get time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function parseSupabaseTimestamp(value) {
            if (!value) return null;
            if (value instanceof Date) return value;

            const str = String(value);
            // If timezone is missing, assume UTC.
            const hasTz = /[zZ]$|[+-]\d\d:\d\d$/.test(str);
            return new Date(hasTz ? str : `${str}Z`);
        }
        
        // ============================================
        // DELETE SUBMISSION
        // ============================================
        
        async function deleteSubmission(id, email) {
            if (!confirm(`Delete submission from ${email}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('scholarship_submissions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showAlert('‚úÖ Submission Deleted', `Successfully deleted submission from ${email}.`);
                
                // Reload recent submissions
                const recentContainer = document.getElementById('recentSubmissions');
                if (recentContainer.querySelector('table')) {
                    // Reload with same limit
                    const rows = recentContainer.querySelectorAll('tbody tr').length;
                    loadRecentSubmissions(rows);
                }
                
                // Reload overview stats
                loadAdminData();
                
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('‚ùå Error', 'Failed to delete submission: ' + error.message);
            }
        }
        
        // ============================================
        // SEARCH USER
        // ============================================
        
        async function searchUser() {
            const email = document.getElementById('searchEmailInput').value.trim();
            const resultsContainer = document.getElementById('userSearchResults');
            
            if (!email) {
                resultsContainer.innerHTML = '<p style="color: var(--warning); padding: 1rem; text-align: center;">Please enter an email address</p>';
                return;
            }
            
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';
            
            try {
                const isLikelyStudentId = /^[0-9\-\s]+$/.test(email);
                const query = window.supabaseClient
                    .from('scholarship_submissions')
                    .select('*')
                    .order('submitted_at', { ascending: false });

                const { data: submissions, error } = isLikelyStudentId
                    ? await query.ilike('student_id', `%${email}%`)
                    : await query.ilike('email', `%${email}%`);
                
                if (error) throw error;
                
                if (submissions.length === 0) {
                    resultsContainer.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No submissions found for "${email}"</p>`;
                    return;
                }
                
                let html = `
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                        <h3 style="color: var(--success); margin-bottom: 0.5rem;">‚úÖ Found ${submissions.length} submission(s)</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Email: <strong>${submissions[0].email}</strong></p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Student ID: <strong>${submissions[0].student_id}</strong></p>
                    </div>
                `;
                
                submissions.forEach(sub => {
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">${sub.department} - ${sub.trimester}</h4>
                                    <p style="color: var(--text-secondary); font-size: 0.85rem;">Submitted: ${new Date(sub.submitted_at).toLocaleString()}</p>
                                </div>
                                <button class="btn btn-danger" onclick="deleteSubmission('${sub.id}', '${sub.email}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                <div>
                                    <p style="color: var(--text-secondary); font-size: 0.85rem;">Last Trimester GPA</p>
                                    <p style="color: var(--text-primary); font-size: 1.5rem; font-weight: 700;">${sub.last_trimester_gpa}</p>
                                </div>
                                <div>
                                    <p style="color: var(--text-secondary); font-size: 0.85rem;">Overall CGPA</p>
                                    <p style="color: var(--text-primary); font-size: 1.5rem; font-weight: 700;">${sub.overall_cgpa}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultsContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<p style="color: var(--danger); text-align: center;">Error searching for user</p>';
            }
        }

        // ============================================
        // FLAGGED SUBMISSIONS
        // ============================================

        async function loadFlaggedSubmissions(includeReviewed = false) {
            const container = document.getElementById('flaggedSubmissions');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading flagged queue...</p></div>';

            try {
                let query = window.supabaseClient
                    .from('flagged_submissions')
                    .select('id, reason, flagged_at, reviewed, reviewer_notes, submission:scholarship_submissions(id,email,student_id,department,trimester,last_trimester_gpa,overall_cgpa,submitted_at)')
                    .order('flagged_at', { ascending: false });

                if (!includeReviewed) {
                    query = query.eq('reviewed', false);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No flagged submissions found.</p>';
                    return;
                }

                let tableHTML = `
                    <div class="table-scroll">
                        <table class="dept-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Reason</th>
                                    <th>Email</th>
                                    <th>Student ID</th>
                                    <th>Dept</th>
                                    <th>Trimester</th>
                                    <th>Flagged</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.forEach(item => {
                    const sub = item.submission || {};
                    const statusChip = item.reviewed
                        ? '<span class="chip success">Reviewed</span>'
                        : '<span class="chip warning">Unreviewed</span>';
                    const flaggedAt = item.flagged_at ? getTimeAgo(new Date(item.flagged_at)) : '‚Äî';

                    tableHTML += `
                        <tr>
                            <td>${statusChip}</td>
                            <td><span class="chip muted">${escapeHtml(item.reason || 'unknown')}</span></td>
                            <td style="font-size: 0.85rem;">${escapeHtml(sub.email || '‚Äî')}</td>
                            <td><strong>${escapeHtml(sub.student_id || '‚Äî')}</strong></td>
                            <td>${escapeHtml(sub.department || '‚Äî')}</td>
                            <td>${escapeHtml(sub.trimester || '‚Äî')}</td>
                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${flaggedAt}</td>
                            <td style="min-width: 220px;">
                                <button class="btn btn-secondary" onclick="markFlagReviewed('${item.id}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex;">‚úÖ Mark reviewed</button>
                                ${sub.id ? `<button class="btn btn-danger" onclick="deleteSubmission('${sub.id}', '${escapeJs(sub.email || 'unknown')}')" style="padding: 0.5rem 0.85rem; font-size: 0.85rem; width: auto; display: inline-flex; margin-left: 0.5rem;">üóëÔ∏è Delete</button>` : ''}
                            </td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table></div>';
                container.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error loading flagged submissions:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem;">
                        <p style="color: var(--danger); font-weight: 700; margin-bottom: 0.25rem;">Unable to load flagged queue</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">This usually means there is no RLS policy allowing access to <strong>flagged_submissions</strong> for anon users.</p>
                    </div>
                `;
            }
        }

        async function markFlagReviewed(flagId) {
            const note = prompt('Reviewer note (optional):') || null;

            try {
                const { error } = await window.supabaseClient
                    .from('flagged_submissions')
                    .update({ reviewed: true, reviewer_notes: note })
                    .eq('id', flagId);

                if (error) throw error;

                showAlert('‚úÖ Updated', 'Flag marked as reviewed.');
                loadFlaggedSubmissions(false);
            } catch (error) {
                console.error('Mark reviewed error:', error);
                showAlert('‚ùå Error', 'Failed to mark as reviewed: ' + error.message);
            }
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function escapeJs(value) {
            return String(value).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }

        // ============================================
        // AUTO-RESTORE ADMIN SESSION (SUPABASE AUTH)
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { data } = await window.supabaseClient.auth.getSession();
                if (data?.session) {
                    const ok = await ensureAdminAccess();
                    if (ok) {
                        showAdminPanel();
                        loadAdminData();
                        loadSiteOverview();
                        loadTeacherAdminOverview();
                        return;
                    }
                }
            } catch (e) {
                console.warn('Admin session restore failed:', e);
            }

            showLoginScreen();
        });
        
        // Add Enter key support for search
        document.getElementById('searchEmailInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchUser();
            }
        });
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ============================================
        // ADMIN TABS
        // ============================================

        function getAdminTabFromHash() {
            const raw = String(window.location.hash || '').replace('#', '').trim();
            if (!raw) return 'dashboard';
            const tab = raw.toLowerCase();
            const allowed = new Set(['dashboard', 'teachers', 'analytics', 'trimester', 'scholarship', 'users', 'export', 'danger']);
            return allowed.has(tab) ? tab : 'dashboard';
        }

        function setAdminTab(tab, opts = {}) {
            const options = { updateHash: true, focus: false, ...opts };
            const normalized = String(tab || '').toLowerCase();
            const nextTab = ['dashboard', 'teachers', 'analytics', 'trimester', 'scholarship', 'users', 'export', 'danger'].includes(normalized)
                ? normalized
                : 'dashboard';

            // Toggle panels
            const panels = document.querySelectorAll('.tab-panel[id^="tab-"]');
            panels.forEach((panel) => {
                const panelTab = panel.id.replace('tab-', '').toLowerCase();
                panel.hidden = panelTab !== nextTab;
            });

            // Update tab buttons
            const buttons = document.querySelectorAll('[data-admin-tab][role="tab"]');
            buttons.forEach((btn) => {
                const isActive = String(btn.getAttribute('data-admin-tab') || '').toLowerCase() === nextTab;
                btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                if (isActive && options.focus) {
                    btn.focus();
                }
            });

            if (options.updateHash) {
                const targetHash = `#${nextTab}`;
                if (window.location.hash !== targetHash) {
                    window.location.hash = nextTab;
                }
            }
        }

        function initAdminTabs() {
            const tablist = document.getElementById('adminTablist');
            if (!tablist || tablist.dataset.initialized === 'true') return;
            tablist.dataset.initialized = 'true';

            tablist.addEventListener('click', (e) => {
                const btn = e.target?.closest?.('[data-admin-tab]');
                if (!btn) return;
                setAdminTab(btn.getAttribute('data-admin-tab'), { updateHash: true, focus: false });
            });

            tablist.addEventListener('keydown', (e) => {
                const keys = ['ArrowLeft', 'ArrowRight', 'Home', 'End'];
                if (!keys.includes(e.key)) return;

                const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                const activeIndex = Math.max(0, tabs.findIndex(t => t.getAttribute('aria-selected') === 'true'));

                let nextIndex = activeIndex;
                if (e.key === 'ArrowLeft') nextIndex = (activeIndex - 1 + tabs.length) % tabs.length;
                if (e.key === 'ArrowRight') nextIndex = (activeIndex + 1) % tabs.length;
                if (e.key === 'Home') nextIndex = 0;
                if (e.key === 'End') nextIndex = tabs.length - 1;

                e.preventDefault();
                const nextTab = tabs[nextIndex];
                setAdminTab(nextTab.getAttribute('data-admin-tab'), { updateHash: true, focus: true });
                nextTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            });

            // Initial tab
            setAdminTab(getAdminTabFromHash(), { updateHash: false, focus: false });
        }

        window.addEventListener('hashchange', () => {
            // Keep in sync when user navigates back/forward.
            if (document.getElementById('adminTablist')) {
                setAdminTab(getAdminTabFromHash(), { updateHash: false, focus: false });
            }
        });
        
        // ============================================
        // CLEAR OLD OTPs
        // ============================================
        
        async function clearOldOTPs() {
            if (!confirm('Clear all verification codes older than 24 hours?')) {
                return;
            }
            
            try {
                const oneDayAgo = new Date();
                oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                
                const { error } = await window.supabaseClient
                    .from('email_verifications')
                    .delete()
                    .lt('created_at', oneDayAgo.toISOString());
                
                if (error) throw error;
                
                showAlert('‚úÖ Success', 'Old verification codes cleared!');
                
            } catch (error) {
                console.error('OTP cleanup error:', error);
                showAlert('‚ùå Error', 'Error clearing OTPs: ' + error.message);
            }
        }
    </script>
</body>
</html>
